name: C++ CI

on:
  pull_request:
    paths-ignore:
      - '**.md'
      - 'Dockerfile'

concurrency:
  group: build-${{ github.event.pull_request.number || github.sha }}
  cancel-in-progress: true

jobs:
  build_ubuntu:
    strategy:
      matrix:
        configurations: [Debug, Release]
        target: [tests, library]
    runs-on: ubuntu-latest
    env:
      BUILD_CONFIGURATION: ${{ matrix.configurations }}

    steps:
      - uses: actions/checkout@v5
        with:
          submodules: recursive

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt install -y libboost-dev libboost-filesystem-dev libboost-program-options-dev
          if [ "${{ matrix.target }}" = "tests" ]; then
            sudo apt install -y libyaml-cpp-dev valgrind
          fi

      - name: Build
        run: |
          mkdir build
          if [ "${{ matrix.target }}" = "library" ]; then
            cmake -B build -DCMAKE_BUILD_TYPE=${{ env.BUILD_CONFIGURATION }} -DVERIFIER_ENABLE_TESTS=OFF
          else
            cmake -B build -DCMAKE_BUILD_TYPE=${{ env.BUILD_CONFIGURATION }} -DVERIFIER_ENABLE_TESTS=ON
          fi
          cmake --build build -j $(nproc)

      - name: Run unit tests
        if: ${{ matrix.target == 'tests' }}
        run: ./tests -d yes

      - name: Test for memory leaks
        if: ${{ matrix.target == 'tests' && matrix.configurations == 'Debug' }}
        run: >
          valgrind --leak-check=full --errors-for-leak-kinds=all
          --show-leak-kinds=all --error-exitcode=1
          ./check ebpf-samples/cilium/bpf_xdp_snat_linux_v1.o 2/1

  build_windows:
    strategy:
      matrix:
        configurations: [Debug, Release]
        target: [tests, library]
    runs-on: windows-2025
    env:
      BUILD_CONFIGURATION: ${{ matrix.configurations }}
      VCPKG_FEATURE_FLAGS: manifests
      VCPKG_BINARY_SOURCES: clear;gha,readwrite
      VCPKG_DEFAULT_TRIPLET: x64-windows
      VCPKG_DEFAULT_BINARY_CACHE: D:/a/vcpkg_cache
      CMAKE_GENERATOR: Ninja

    steps:
      - uses: actions/checkout@v5
        with:
          submodules: recursive

      - name: Setup CMake and Ninja
        uses: lukka/get-cmake@latest

      - name: Setup sccache
        uses: mozilla-actions/sccache-action@v0.0.9
        env:
          SCCACHE_GHA_ENABLED: "true"

      - name: Configure (vcpkg manifest mode)
        shell: pwsh
        run: |
          $toolchain = "vcpkg/scripts/buildsystems/vcpkg.cmake"
          cmake -S . -B build `
            -G "${env:CMAKE_GENERATOR}" `
            -D CMAKE_BUILD_TYPE=${{ env.BUILD_CONFIGURATION }} `
            -D CMAKE_TOOLCHAIN_FILE=$toolchain `
            -D CMAKE_C_COMPILER_LAUNCHER=sccache `
            -D CMAKE_CXX_COMPILER_LAUNCHER=sccache `
            -D VERIFIER_ENABLE_TESTS=$([bool](${env:matrix_target} -eq 'tests'))

      - name: Build
        run: cmake --build build --config ${{ env.BUILD_CONFIGURATION }} --parallel

      - name: Run unit tests
        if: ${{ matrix.target == 'tests' }}
        working-directory: build
        run: .\${{ env.BUILD_CONFIGURATION }}\tests.exe --reporter compact

      - name: "Fallback: NuGet build"
        if: failure()
        shell: pwsh
        run: |
          choco install nuget.commandline -y
          cmake -S . -B build-nuget `
            -G "${env:CMAKE_GENERATOR}" `
            -D VERIFIER_USE_NUGET_FALLBACK=ON `
            -D VERIFIER_ENABLE_TESTS=$([bool](${env:matrix_target} -eq 'tests'))
          cmake --build build-nuget --config ${{ env.BUILD_CONFIGURATION }} --parallel
          .\build-nuget\${{ env.BUILD_CONFIGURATION }}\tests.exe --reporter compact
