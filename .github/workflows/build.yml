---
name: C++ CI

"on":
  pull_request:
    paths-ignore:
      - '**.md'
      - 'Dockerfile'

concurrency:
  group: build-${{ github.event.pull_request.number || github.sha }}
  cancel-in-progress: true

jobs:
  build_ubuntu:
    strategy:
      matrix:
        configurations: [Debug, Release]
        target: [tests, library]
      fail-fast: false
    runs-on: ubuntu-latest
    env:
      CMAKE_GENERATOR: Ninja
    steps:
      - uses: actions/checkout@v5
        with:
          submodules: recursive

      - name: Install dependencies (Ubuntu)
        run: |
          sudo apt-get update
          sudo apt install -y cmake ninja-build g++ libboost-dev libboost-filesystem-dev libboost-program-options-dev
          if [ "${{ matrix.target }}" = "tests" ]; then
            sudo apt install -y libyaml-cpp-dev valgrind
          fi

      - name: Build
        run: |
          cmake -S . -B build \
            -G "${{ env.CMAKE_GENERATOR }}" \
            -D CMAKE_BUILD_TYPE=${{ env.BUILD_CONFIGURATION }} \
            -D VERIFIER_ENABLE_TESTS=$([ "${{ matrix.target }}" = "tests" ] && echo ON || echo OFF)
          cmake --build build -- -j $(nproc)

      - name: Run unit tests
        if: ${{ matrix.target == 'tests' }}
        run: ./tests -d yes

      - name: Memory leak test (Debug only)
        if: ${{ matrix.target == 'tests' && matrix.configurations == 'Debug' }}
        run: >
          valgrind --leak-check=full --errors-for-leak-kinds=all
          --show-leak-kinds=all --error-exitcode=1
          ./check ebpf-samples/cilium/bpf_xdp_snat_linux_v1.o 2/1

  build_windows:
    strategy:
      matrix:
        configurations: [Debug, Release]
        target: [tests, library]
      fail-fast: false
    runs-on: windows-2025
    env:
      MATRIX_TARGET: ${{ matrix.target }}
      BUILD_CONFIGURATION: ${{ matrix.configurations }}
      CMAKE_GENERATOR: "Visual Studio 17 2022"
      BOOST_VERSION: "1.87.0"
    steps:
      - uses: actions/checkout@v5
        with:
          submodules: recursive

      - name: Cache Boost packages
        id: cache-boost
        uses: actions/cache@v4
        with:
          path: ${{ github.workspace }}\build\packages
          key: boost-${{ runner.os }}-1.87.0

      - name: Install Boost (NuGet prebuilt)
        if: ${{ steps.cache-boost.outputs.cache-hit != 'true' }}
        shell: pwsh
        run: |
          $root = Join-Path $env:GITHUB_WORKSPACE "build\packages"
          New-Item -ItemType Directory -Force -Path $root | Out-Null

          nuget install boost -Version $env:BOOST_VERSION -ExcludeVersion -DirectDownload -OutputDirectory $root
          # Prevent bpf_conformance from reinstalling boost packages
          nuget install boost_filesystem-vc143 -Version $env:BOOST_VERSION -ExcludeVersion -OutputDirectory $root
          nuget install boost_program_options-vc143 -Version $env:BOOST_VERSION -ExcludeVersion -OutputDirectory $root

      - name: Configure CMake
        shell: pwsh
        run: |
          $boostDir = Join-Path $env:GITHUB_WORKSPACE "\build\packages\boost-vc143\lib\native\lib\cmake\Boost"
          $enableTests = if ($env:MATRIX_TARGET -eq "tests") { "ON" } else { "OFF" }

          cmake -S . -B build `
            -G "$env:CMAKE_GENERATOR" `
            -D CMAKE_BUILD_TYPE="$env:BUILD_CONFIGURATION" `
            -D CMAKE_PREFIX_PATH="$boostDir" `
            -D Boost_DIR="$boostDir" `
            -D VERIFIER_ENABLE_TESTS=$enableTests

      - name: Build
        shell: pwsh
        run: cmake --build build --config "$env:BUILD_CONFIGURATION" --parallel

      - name: Run unit tests
        if: ${{ matrix.target == 'tests' }}
        run: ./${{ env.BUILD_CONFIGURATION }}/tests.exe -d yes
        shell: pwsh
